<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroNeko — Плеєр</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <link rel="stylesheet" href="style/player.css">
</head>
<body>
  <header>
    <img src="images/favicon1.png" alt="Logo">
    <h1>AstroNeko Плеєр</h1>
  </header>

  <main>
    <div class="player-container">
      <video id="anime-video" controls>
        Ваш браузер не підтримує відео.
      </video>

      <div class="controls">
        <label for="voice-selection">Озвучка:</label>
        <select id="voice-selection"></select>
      </div>

      <div class="info">
        <p>Сезон: <span id="season-number">?</span></p>
        <p>Епізод: <span id="episode-number">?</span></p>
      </div>
    </div>
  </main>

  <script>
    const params = new URLSearchParams(window.location.search);
    const animeId = params.get("anime");
    const seasonNum = parseInt(params.get("season"));
    const episodeNum = parseInt(params.get("episode"));

    const video = document.getElementById("anime-video");
    const seasonEl = document.getElementById("season-number");
    const episodeEl = document.getElementById("episode-number");
    const voiceSelect = document.getElementById("voice-selection");

    seasonEl.textContent = seasonNum || "?";
    episodeEl.textContent = episodeNum || "?";

    async function loadEpisode() {
      try {
        if (!animeId || !seasonNum || !episodeNum) throw new Error("Не вказано всі параметри");

        const resp = await fetch(`anime/${encodeURIComponent(animeId)}.json`);
        if (!resp.ok) throw new Error("Не вдалося знайти JSON аніме");

        const anime = await resp.json();
        const season = anime.seasons.find(s => s.seasonNumber === seasonNum);
        if (!season) throw new Error("Сезон не знайдено");

        const episode = season.episodes[episodeNum - 1];
        if (!episode) throw new Error("Епізод не знайдено");

        voiceSelect.innerHTML = "";

        episode.dubbing.forEach(dub => {
          const option = document.createElement("option");
          option.value = dub.videoUrl;
          option.textContent = dub.studio;
          voiceSelect.appendChild(option);
        });

        if (episode.dubbing.length > 0) {
          video.src = episode.dubbing[0].videoUrl;
          video.play();
        }
      } catch(err) {
        alert(err.message);
        console.error(err);
      }
    }

    voiceSelect.addEventListener("change", e => {
      video.src = e.target.value;
      video.play();
    });

    loadEpisode();
  </script>
</body>
</html>