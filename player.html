<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroNeko — Плеєр</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <link rel="stylesheet" href="style/player.css">
</head>
<body>
  <div class="anime-bg" id="anime-bg"></div>
  <header>
    <a href="index.html" class="logo">
      <img src="images/favicon1.png" alt="Logo">
      <h1>AstroNeko</h1>
    </a>
    <nav class="header-nav">
      <a href="index.html">Головна</a>
      <button id="backToInfo">Повернутися до аніме</button>
    </nav>
  </header>

  <div class="player-wrapper">
    <video id="anime-player" controls></video>

    <div class="controls-row">
      <span id="season-or-movie">?</span>
      <span id="episode-number">?</span>
      <span id="episode-title">?</span>
      
      <button id="open-settings" class="settings-btn">⚙️ Налаштування</button>

      <button id="prev-episode">Попередня серія</button>
      <button id="next-episode">Наступна серія</button>
    </div>
  </div>

  <!-- Спливаюче вікно налаштувань -->
  <div id="settings-modal" class="settings-modal">
    <div class="settings-content">
      <div class="settings-header">
        <h3>Налаштування плеєра</h3>
        <button id="close-settings" class="close-btn">&times;</button>
      </div>
      
      <div class="settings-body">
        <!-- Озвучка -->
        <div class="setting-group">
          <label for="settings-audio">Озвучка:</label>
          <select id="settings-audio" class="settings-select">
            <option value="">Завантаження...</option>
          </select>
        </div>
        
        <!-- Якість -->
        <div class="setting-group">
          <label for="settings-quality">Якість:</label>
          <select id="settings-quality" class="settings-select">
            <option value="">Спочатку оберіть озвучку</option>
          </select>
        </div>
        
        <!-- Авто-скіп -->
        <div class="setting-group">
          <label>Авто-скіп:</label>
          <a href="#" class="toggle-link" id="auto-skip-link">
            <span class="toggle-icon">☐</span>
            <span class="toggle-text">Автоматично пропускати опенінг/ендінг</span>
          </a>
        </div>
        
        <!-- Авто-продовження -->
        <div class="setting-group">
          <label>Авто-продовження:</label>
          <a href="#" class="toggle-link" id="auto-next-link">
            <span class="toggle-icon">☐</span>
            <span class="toggle-text">Автоматично переходити на наступну серію</span>
          </a>
        </div>
      </div>
      
      <div class="settings-footer">
        <button id="close-modal" class="apply-btn">Закрити</button>
      </div>
    </div>
  </div>

  <script>
    // Основний клас для управління плеєром
    class AnimePlayer {
      constructor() {
        this.params = new URLSearchParams(window.location.search);
        this.animeId = this.params.get("id");
        this.seasonNumber = parseInt(this.params.get("season"));
        this.episodeNumber = parseInt(this.params.get("episode"));
        this.movieNumber = parseInt(this.params.get("movie"));
        
        this.player = document.getElementById("anime-player");
        this.seasonOrMovieSpan = document.getElementById("season-or-movie");
        this.episodeNumSpan = document.getElementById("episode-number");
        this.titleSpan = document.getElementById("episode-title");
        this.prevBtn = document.getElementById("prev-episode");
        this.nextBtn = document.getElementById("next-episode");
        this.backToInfoBtn = document.getElementById("backToInfo");

        // Елементи налаштувань
        this.settingsModal = document.getElementById('settings-modal');
        this.openSettingsBtn = document.getElementById('open-settings');
        this.closeSettingsBtn = document.getElementById('close-settings');
        this.closeModalBtn = document.getElementById('close-modal');
        this.settingsAudioSelect = document.getElementById('settings-audio');
        this.settingsQualitySelect = document.getElementById('settings-quality');
        this.autoSkipLink = document.getElementById('auto-skip-link');
        this.autoNextLink = document.getElementById('auto-next-link');

        // Стан плеєра
        this.currentEpisode = null;
        this.currentAnime = null;
        this.currentDubbingStudio = null;
        this.currentQuality = null;
        this.autoSkipInterval = null;
        this.autoSkipEnabled = false;
        this.autoNextEnabled = false;

        this.init();
      }

      init() {
        this.setupEventListeners();
        this.loadPlayer();
        this.setupAutoHideHeader();
      }

      setupEventListeners() {
        // Навігація
        this.backToInfoBtn.onclick = () => this.goBackToInfo();
        this.prevBtn.onclick = () => this.goToPreviousEpisode();
        this.nextBtn.onclick = () => this.goToNextEpisode();

        // Налаштування
        this.openSettingsBtn.addEventListener('click', () => this.openSettings());
        this.closeSettingsBtn.addEventListener('click', () => this.closeSettings());
        this.closeModalBtn.addEventListener('click', () => this.closeSettings());
        this.settingsModal.addEventListener('click', (e) => {
          if (e.target === this.settingsModal) this.closeSettings();
        });

        // Перемикачі налаштувань
        this.autoSkipLink.addEventListener('click', (e) => this.toggleAutoSkip(e));
        this.autoNextLink.addEventListener('click', (e) => this.toggleAutoNext(e));
        this.settingsAudioSelect.addEventListener('change', () => this.onAudioChange());
        this.settingsQualitySelect.addEventListener('change', () => this.onQualityChange());

        // Збереження прогресу
        this.player.addEventListener('timeupdate', () => this.throttledSaveProgress());
        this.player.addEventListener('volumechange', () => this.saveSettings());
        window.addEventListener('beforeunload', () => {
          this.saveProgress();
          this.saveSettings();
        });
      }

      // Основний метод завантаження плеєра
      async loadPlayer() {
        if (!this.animeId) {
          alert("Не вказано всі параметри для плеєра!");
          return;
        }

        try {
          const anime = await this.fetchAnimeData();
          this.currentAnime = anime;
          
          this.setupPage(anime);
          await this.setupEpisode();
          this.setupNavigation();
          this.setupTooltip();

        } catch (err) {
          console.error(err);
          alert("Помилка при завантаженні плеєра");
        }
      }

      async fetchAnimeData() {
        const resp = await fetch(`anime/${encodeURIComponent(this.animeId)}.json`);
        if (!resp.ok) throw new Error("Не вдалося завантажити аніме");
        return await resp.json();
      }

      setupPage(anime) {
        document.getElementById("anime-bg").style.backgroundImage = `url('${anime.background}')`;
        document.title = `Дивитися — ${anime.title}`;
      }

      async setupEpisode() {
        const episode = this.findCurrentEpisode();
        if (!episode) throw new Error("Епізод не знайдено");

        this.currentEpisode = episode;
        this.updateEpisodeInfo();
        
        const preferences = this.getAnimePreferences();
        this.applyPreferences(preferences);
        
        await this.loadVideo();
        this.restoreProgress();
        this.setupAutoFeatures();
      }

      findCurrentEpisode() {
        if (this.seasonNumber) {
          const season = this.currentAnime.seasons.find(s => s.seasonNumber === this.seasonNumber);
          return season ? season.episodes[this.episodeNumber - 1] : null;
        } else if (this.movieNumber) {
          return this.currentAnime.movies[this.movieNumber - 1];
        }
        return null;
      }

      updateEpisodeInfo() {
        const isMovie = !!this.movieNumber;
        
        if (isMovie) {
          this.seasonOrMovieSpan.textContent = `Фільм ${this.movieNumber}`;
          this.episodeNumSpan.textContent = "";
        } else {
          this.seasonOrMovieSpan.textContent = `Сезон ${this.seasonNumber}`;
          this.episodeNumSpan.textContent = `Серія ${this.episodeNumber}`;
        }
        this.titleSpan.textContent = this.currentEpisode.name;
      }

      applyPreferences(preferences) {
        // Застосування налаштувань озвучки та якості
        let dubbingIndex = 0;
        let qualityIndex = 0;

        if (preferences.dubbing) {
          const preferredDubbingIndex = this.currentEpisode.dubbing.findIndex(d => d.studio === preferences.dubbing);
          if (preferredDubbingIndex !== -1) dubbingIndex = preferredDubbingIndex;
          
          if (preferences.quality) {
            const selectedDubbing = this.currentEpisode.dubbing[dubbingIndex];
            const preferredQualityIndex = selectedDubbing.quality.findIndex(q => q.value === preferences.quality);
            if (preferredQualityIndex !== -1) qualityIndex = preferredQualityIndex;
          }
        }

        this.currentDubbingStudio = this.currentEpisode.dubbing[dubbingIndex].studio;
        this.currentQuality = this.currentEpisode.dubbing[dubbingIndex].quality[qualityIndex].value;
        
        // Застосування гучності
        if (preferences.volume !== undefined) {
          this.player.volume = preferences.volume;
        }

        // Застосування автоматичних функцій
        this.autoSkipEnabled = Boolean(preferences.autoSkip);
        this.autoNextEnabled = Boolean(preferences.autoNext);
      }

      async loadVideo() {
        const selectedDubbing = this.currentEpisode.dubbing.find(d => d.studio === this.currentDubbingStudio);
        const selectedQuality = selectedDubbing.quality.find(q => q.value === this.currentQuality);
        
        this.player.src = selectedQuality.videoUrl;
        
        return new Promise((resolve) => {
          this.player.addEventListener('loadedmetadata', () => resolve(), { once: true });
        });
      }

      restoreProgress() {
        const progress = this.getEpisodeProgress();
        if (progress && progress.time) {
          this.player.currentTime = Math.min(progress.time, this.player.duration - 1);
        }
      }

      setupAutoFeatures() {
        this.setupAutoSkip();
        this.setupAutoNext();
      }

      // Решта методів залишаються аналогічними до вашого коду...
      // (goBackToInfo, goToPreviousEpisode, goToNextEpisode, openSettings, closeSettings, etc.)

      // Допоміжні методи для роботи з localStorage
      getAnimePreferences() {
        const key = `preferences_${this.animeId}`;
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : {};
      }

      setAnimePreferences(preferences) {
        const key = `preferences_${this.animeId}`;
        localStorage.setItem(key, JSON.stringify(preferences));
      }

      getEpisodeProgress() {
        if (!this.seasonNumber) return null;
        const key = `progress_${this.animeId}_s${this.seasonNumber}_e${this.episodeNumber}`;
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : null;
      }

      setEpisodeProgress(progress) {
        if (!this.seasonNumber) return;
        const key = `progress_${this.animeId}_s${this.seasonNumber}_e${this.episodeNumber}`;
        localStorage.setItem(key, JSON.stringify(progress));
      }

      // Інші методи...
    }

    // Ініціалізація плеєра при завантаженні сторінки
    document.addEventListener('DOMContentLoaded', () => {
      new AnimePlayer();
    });
  </script>
</body>
</html>