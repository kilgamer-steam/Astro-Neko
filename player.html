<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroNeko ‚Äî –ü–ª–µ—î—Ä</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <link rel="stylesheet" href="style/player.css">
</head>
<body>
  <!-- –§–æ–Ω —Å—Ç–æ—Ä—ñ–Ω–∫–∏ -->
  <div class="page-background" id="page-background"></div>

  <header>
    <a href="index.html" class="logo">
      <img src="images/favicon1.png" alt="Logo">
      <h1>AstroNeko</h1>
    </a>
  </header>

  <div class="player-wrapper">
    <video id="anime-player" controls autoplay></video>

    <div class="controls-row">
      <label id="season-label">–°–µ–∑–æ–Ω: <span id="season-number">?</span></label>
      <label id="episode-label">–°–µ—Ä—ñ—è: <span id="episode-number">?</span></label>
      <label id="title-label">–ù–∞–∑–≤–∞: <span id="episode-title">?</span></label>
      <label>–û–∑–≤—É—á–∫–∞:
        <select id="audio-select"></select>
      </label>
      <button id="prev-ep">–ü–æ–ø–µ—Ä–µ–¥–Ω—è</button>
      <button id="next-ep">–ù–∞—Å—Ç—É–ø–Ω–∞</button>
    </div>
  </div>

  <script>
  const params = new URLSearchParams(window.location.search);
  const animeId = params.get("id");
  const seasonNumber = parseInt(params.get("season"));
  const episodeNumber = parseInt(params.get("episode"));

  async function loadPlayer() {
    if (!animeId || !seasonNumber || !episodeNumber) {
      alert("–ù–µ –≤–∫–∞–∑–∞–Ω–æ –≤—Å—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –¥–ª—è –ø–ª–µ—î—Ä–∞!");
      return;
    }

    try {
      const resp = await fetch(`anime/${encodeURIComponent(animeId)}.json`);
      if (!resp.ok) throw new Error("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –∞–Ω—ñ–º–µ");
      const anime = await resp.json();

      // üñº –§–æ–Ω —Å—Ç–æ—Ä—ñ–Ω–∫–∏
      const bg = document.getElementById("page-background");
      bg.style.backgroundImage = `url('${anime.background || anime.img}')`;

      const player = document.getElementById("anime-player");
      const select = document.getElementById("audio-select");
      const seasonLabel = document.getElementById("season-label");
      const episodeLabel = document.getElementById("episode-label");
      const titleSpan = document.getElementById("episode-title");

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ —Å–µ–∑–æ–Ω
      const season = anime.seasons.find(s => s.seasonNumber === seasonNumber);
      if (!season) throw new Error("–°–µ–∑–æ–Ω –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");

      // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –µ–ø—ñ–∑–æ–¥
      const episode = season.episodes[episodeNumber - 1];
      if (!episode) throw new Error("–ï–ø—ñ–∑–æ–¥ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ");

      // –Ø–∫—â–æ —Ü–µ —Ñ—ñ–ª—å–º
      if (anime.type && anime.type.toLowerCase() === "movie") {
        seasonLabel.innerHTML = `–§—ñ–ª—å–º: <span id="season-number">${seasonNumber}</span>`;
        episodeLabel.innerHTML = `–ù–æ–º–µ—Ä: <span id="episode-number">${episodeNumber}</span>`;
      } else {
        seasonLabel.innerHTML = `–°–µ–∑–æ–Ω: <span id="season-number">${seasonNumber}</span>`;
        episodeLabel.innerHTML = `–°–µ—Ä—ñ—è: <span id="episode-number">${episodeNumber}</span>`;
      }

      titleSpan.textContent = episode.title || "–ë–µ–∑ –Ω–∞–∑–≤–∏";

      // –û–∑–≤—É—á–∫–∏
      select.innerHTML = "";
      episode.dubbing.forEach((d, i) => {
        const option = document.createElement("option");
        option.value = d.videoUrl;
        option.textContent = d.studio;
        select.appendChild(option);
      });

      // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø–µ—Ä—à–µ –≤—ñ–¥–µ–æ
      player.src = episode.dubbing[0].videoUrl;

      // –ó–º—ñ–Ω–∞ –æ–∑–≤—É—á–∫–∏
      select.addEventListener("change", () => {
        player.src = select.value;
        player.play();
      });

      // –ù–∞—Å—Ç—É–ø–Ω–∞/–ø–æ–ø–µ—Ä–µ–¥–Ω—è —Å–µ—Ä—ñ—è
      document.getElementById("prev-ep").addEventListener("click", () => {
        if (episodeNumber > 1) {
          window.location.href = `player.html?id=${animeId}&season=${seasonNumber}&episode=${episodeNumber - 1}`;
        }
      });
      document.getElementById("next-ep").addEventListener("click", () => {
        if (episodeNumber < season.episodes.length) {
          window.location.href = `player.html?id=${animeId}&season=${seasonNumber}&episode=${episodeNumber + 1}`;
        }
      });

    } catch (err) {
      console.error(err);
      alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ –ø–ª–µ—î—Ä–∞");
    }
  }

  loadPlayer();
  </script>
</body>
</html>
