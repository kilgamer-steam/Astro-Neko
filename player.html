<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AstroNeko — Плеєр</title>
  <link rel="icon" href="images/favicon.png" type="image/png">
  <link rel="stylesheet" href="style/player.css">
</head>
<body>
  <header>
    <a href="index.html" class="logo">
      <img src="images/favicon1.png" alt="Logo">
      <h1>AstroNeko</h1>
    </a>
  </header>

  <main class="player-container">
    <video id="anime-player" controls autoplay class="player"></video>

    <div class="player-controls">
      <label>Сезон / Фільм: <span id="season-number">?</span></label>
      <label>Серія / Номер: <span id="episode-number">?</span></label>
      <label>Назва: <span id="episode-title">?</span></label>

      <label>Озвучка:
        <select id="audio-select"></select>
      </label>

      <button id="prev-episode">Попередня серія</button>
      <button id="next-episode">Наступна серія</button>
    </div>
  </main>

<script>
const params = new URLSearchParams(window.location.search);
const animeId = params.get("anime");
const seasonNumber = parseInt(params.get("season"));
const episodeNumber = parseInt(params.get("episode"));

let currentSeason = seasonNumber;
let currentEpisode = episodeNumber;

async function loadPlayer() {
  if (!animeId || !currentSeason || !currentEpisode) {
    alert("Не вказано всі параметри для плеєра!");
    return;
  }

  try {
    const resp = await fetch(`anime/${encodeURIComponent(animeId)}.json`);
    if (!resp.ok) throw new Error("Не вдалося завантажити аніме");
    const anime = await resp.json();

    const isMovie = !anime.seasons || anime.seasons.length === 0; // визначаємо фільм
    let season, episode;

    if (!isMovie) {
      season = anime.seasons.find(s => s.seasonNumber === currentSeason);
      if (!season) throw new Error("Сезон не знайдено");
      episode = season.episodes[currentEpisode - 1];
      if (!episode) throw new Error("Епізод не знайдено");
    } else {
      episode = anime.movies.find(m => m.number === currentEpisode);
      if (!episode) throw new Error("Фільм не знайдено");
    }

    const player = document.getElementById("anime-player");

    // Автовибір першої озвучки
    let currentDubbing = episode.dubbing[0];
    player.src = currentDubbing.videoUrl;

    // Заповнюємо select для озвучок
    const audioSelect = document.getElementById("audio-select");
    audioSelect.innerHTML = "";
    episode.dubbing.forEach((d, idx) => {
      const opt = document.createElement("option");
      opt.value = idx;
      opt.textContent = d.studio;
      audioSelect.appendChild(opt);
    });

    audioSelect.onchange = () => {
      const dub = episode.dubbing[audioSelect.value];
      player.src = dub.videoUrl;
      player.play();
    };

    // Відображення інформації
    const seasonEl = document.getElementById("season-number");
    const episodeEl = document.getElementById("episode-number");
    const titleEl = document.getElementById("episode-title");

    if (isMovie) {
      seasonEl.textContent = `${episode.number}`;
      episodeEl.parentElement.style.display = "none"; // приховуємо серію
    } else {
      seasonEl.textContent = `${currentSeason}`;
      episodeEl.textContent = `${currentEpisode}`;
      episodeEl.parentElement.style.display = "inline";
    }

    titleEl.textContent = episode.name;

    // Кнопки попередня / наступна серія
    const prevBtn = document.getElementById("prev-episode");
    const nextBtn = document.getElementById("next-episode");

    if (isMovie) {
      prevBtn.style.display = "none";
      nextBtn.style.display = "none";
    } else {
      prevBtn.style.display = "inline";
      nextBtn.style.display = "inline";

      prevBtn.onclick = () => {
        if (currentEpisode > 1) {
          currentEpisode--;
          loadPlayer();
        }
      };

      nextBtn.onclick = () => {
        if (currentEpisode < season.episodes.length) {
          currentEpisode++;
          loadPlayer();
        }
      };
    }

  } catch (err) {
    console.error(err);
    alert("Помилка при завантаженні плеєра");
  }
}

loadPlayer();
</script>
</body>
</html>
